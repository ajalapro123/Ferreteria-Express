<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Catálogo de productos</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    header { background: #414141; color: #fff; padding: 15px; text-align: center; }
    header h1 { margin: 0; }
    nav ul { list-style: none; display: flex; justify-content: center; gap: 15px; padding: 0; margin: 10px 0 0; }
    nav ul li a { color: white; text-decoration: none; font-weight: bold; }

    .productos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 20px; }
    .producto-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
    .producto-card h3 { margin: 10px 0 6px; color: #222; }
    .producto-card p { margin: 6px 0; }

    .producto-img{
      width: 100%;
      height: 160px;
      object-fit: contain;
      border-radius: 6px;
      margin-bottom: 8px;
      background: #fafafa;
    }

    .btn-comprar { margin-top: 10px; padding: 10px 15px; background: #ff6600; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-comprar:hover { background: #e65c00; }

    .carrito { position: fixed; top: 0; right: -400px; width: 350px; height: 100%; background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.3); padding: 20px; transition: right 0.3s ease; overflow-y: auto; z-index: 1000; }
    .carrito.abierto { right: 0; }
    .carrito h2 { margin-top: 0; }
    .carrito-item { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
    .carrito-item button { background: none; border: none; color: red; cursor: pointer; font-size: 14px; }
    .carrito-footer { margin-top: 20px; text-align: center; }
    .btn-finalizar, .btn-ver-carrito { display: block; width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
    .btn-finalizar { background: #ff6600; color: white; font-weight: bold; }
    .btn-ver-carrito { background: #f4f4f4; color: #333; border: 1px solid #ddd; }
    .btn-cerrar { float: right; background: none; border: none; font-size: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Catálogo de Productos</h1>
    <nav>
      <ul>
        <li><a href="../index.html">Inicio</a></li>
        <li><a href="../cart/cart.html">Carrito</a></li>
        <li><a href="../user/login.html">Login</a></li>
        <li><a href="../user/register.html">Registro</a></li>
        <li><a href="../orders/history.html">Historial</a></li>
        <li><a href="../contact/contact.html">Contacto</a></li>
        <li><a href="../support/support.html">Soporte</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2 style="text-align:center; margin-top:20px;">Productos destacados</h2>
    <div id="productos" class="productos-grid"></div>
  </main>

  <!-- Panel lateral del carrito (faltaba en este HTML) -->
  <aside id="carrito" class="carrito" aria-hidden="true">
    <button class="btn-cerrar" onclick="toggleCarrito()" aria-label="Cerrar carrito">×</button>
    <h2>Tu carrito</h2>
    <div id="carrito-items"></div>
    <div class="carrito-footer">
      <p id="carrito-total">Total: $0</p>
      <button class="btn-finalizar">Finalizar pedido</button>
      <button class="btn-ver-carrito" onclick="irAlCarrito()">Ver carrito</button>
    </div>
  </aside>

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Script común del carrito (helpers + factura) cargado antes para disponer de globals) -->
  <script src="../assets/js/cartCore.js"></script>

  <script>
  // usar implementación compartida en cartCore.js -> window.mostrarFacturaModal

  function actualizarCarrito() {
    const cont = document.getElementById("carrito-items");
    const totalEl = document.getElementById("carrito-total");

    // Si el panel no existe (por alguna razón), solo sincroniza LS y sal.
    if (!cont || !totalEl) {
      setCartLS(carrito);
      return;
    }

    cont.innerHTML = "";
    let total = 0;

    carrito.forEach((it, i) => {
      total += it.precio * it.cantidad;

      cont.innerHTML += `
      <div class="carrito-item">
        <span>${it.nombre} - $${it.precio.toLocaleString()} x ${it.cantidad}</span>
        <button onclick="removerDelCarrito(${i})">Eliminar</button>
      </div>`;
    });

    totalEl.textContent = "Total: $" + total.toLocaleString();
    setCartLS(carrito);
  }

  window.removerDelCarrito = function(i) {
    carrito.splice(i, 1);
    actualizarCarrito();
  };

  window.agregarAlCarritoPorId = function(id) {
    const p = productosCache.find(x => x.id === id);
    if (!p) return;

    const enCarrito = carrito.find(x => x.id === id)?.cantidad || 0;
    const disponible = Number(p.cantidad);

    if (enCarrito + 1 > disponible) {
      Swal.fire({
        icon: "warning",
        title: "Stock insuficiente",
        text: `No hay suficiente stock de "${p.nombre}".`
      });
      return;
    }

    const ex = carrito.find(x => x.id === id);
    if (ex) {
      ex.cantidad++;
    } else {
      carrito.push({
        id: p.id,
        nombre: p.nombre,
        precio: Number(p.precio),
        cantidad: 1,
        imagen: srcDeProducto(p)
      });
    }

    actualizarCarrito();
    toggleCarrito();
  };

  window.irAlCarrito = function() {
    setCartLS(carrito);
    location.href = "../cart/cart.html";
  };

  // ============================================
  // ✅ FINALIZAR PEDIDO — (BLOQUE CORREGIDO)
  // ============================================
  document.addEventListener("DOMContentLoaded", () => {
    const btnFinal = document.querySelector(".btn-finalizar");
    if (btnFinal) btnFinal.addEventListener("click", finalizarDesdeCatalogo);
  });

  async function finalizarDesdeCatalogo() {
    if (!carrito.length) {
      Swal.fire({
        icon: "info",
        title: "Carrito vacío",
        text: "Tu carrito está vacío."
      });
      return;
    }

    const user = JSON.parse(localStorage.getItem("usuario") || "null");

    const payload = {
      clienteId: user?.id ?? null,
      metodoPago: "Efectivo",
      items: carrito.map(x => ({
        id: x.id,
        cantidad: x.cantidad
      }))
    }; // ✅ CERRADO CORRECTAMENTE

    try {
      const r = await fetch(`${API_URL}/checkout`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await r.json();

      if (!r.ok || !data.ok) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.mensaje || "No se pudo confirmar el pedido"
        });
        return;
      }

      mostrarFacturaModal(data.venta, data.venta.items || carrito);

      carrito = [];
      actualizarCarrito();
      localStorage.setItem("lastCheckout", Date.now());
      await cargarProductos();

    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Error procesando el pedido."
      });
    }
  }

  // Inicialización diferida para asegurar que cartCore haya cargado
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof getCartLS === 'function') {
      carrito = getCartLS();
    } else {
      carrito = [];
    }
    actualizarCarrito();
    if (typeof cargarProductos === 'function') {
      cargarProductos();
    }
  });
  </script>
</body>
</html>
