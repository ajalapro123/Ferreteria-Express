<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Catálogo de productos</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    header { background: #414141; color: #fff; padding: 15px; text-align: center; }
    header h1 { margin: 0; }
    nav ul { list-style: none; display: flex; justify-content: center; gap: 15px; padding: 0; margin: 10px 0 0; }
    nav ul li a { color: white; text-decoration: none; font-weight: bold; }

    .productos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 20px; }
    .producto-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
    .producto-card h3 { margin: 10px 0 6px; color: #222; }
    .producto-card p { margin: 6px 0; }

    .producto-img{
      width: 100%;
      height: 160px;
      object-fit: contain;
      border-radius: 6px;
      margin-bottom: 8px;
      background: #fafafa;
    }

    .btn-comprar { margin-top: 10px; padding: 10px 15px; background: #ff6600; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-comprar:hover { background: #e65c00; }

    .carrito { position: fixed; top: 0; right: -400px; width: 350px; height: 100%; background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.3); padding: 20px; transition: right 0.3s ease; overflow-y: auto; z-index: 1000; }
    .carrito.abierto { right: 0; }
    .carrito h2 { margin-top: 0; }
    .carrito-item { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
    .carrito-item button { background: none; border: none; color: red; cursor: pointer; font-size: 14px; }
    .carrito-footer { margin-top: 20px; text-align: center; }
    .btn-finalizar, .btn-ver-carrito { display: block; width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
    .btn-finalizar { background: #ff6600; color: white; font-weight: bold; }
    .btn-ver-carrito { background: #f4f4f4; color: #333; border: 1px solid #ddd; }
    .btn-cerrar { float: right; background: none; border: none; font-size: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Catálogo de Productos</h1>
    <nav>
      <ul>
        <li><a href="../index.html">Inicio</a></li>
        <li><a href="../cart/cart.html">Carrito</a></li>
        <li><a href="../user/login.html">Login</a></li>
        <li><a href="../user/register.html">Registro</a></li>
        <li><a href="../orders/history.html">Historial</a></li>
        <li><a href="../contact/contact.html">Contacto</a></li>
        <li><a href="../support/support.html">Soporte</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2 style="text-align:center; margin-top:20px;">Productos destacados</h2>
    <div id="productos" class="productos-grid"></div>
  </main>

  <!-- Panel lateral del carrito (faltaba en este HTML) -->
  <aside id="carrito" class="carrito" aria-hidden="true">
    <button class="btn-cerrar" onclick="toggleCarrito()" aria-label="Cerrar carrito">×</button>
    <h2>Tu carrito</h2>
    <div id="carrito-items"></div>
    <div class="carrito-footer">
      <p id="carrito-total">Total: $0</p>
      <button class="btn-finalizar">Finalizar pedido</button>
      <button class="btn-ver-carrito" onclick="irAlCarrito()">Ver carrito</button>
    </div>
  </aside>

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  // ============================================
  // ✅ CONFIG
  // ============================================
  const API_URL = "https://ferreteriaexpress.shop/api";

  const BACKEND_ORIGIN = (() => {
    try { return new URL(API_URL).origin; }
    catch { return "https://ferreteriaexpress.shop"; }
  })();

  let carrito = [];
  let productosCache = [];

  function getCartLS() { 
    return JSON.parse(localStorage.getItem("carrito") || "[]");
  }

  function setCartLS(v) {
    localStorage.setItem("carrito", JSON.stringify(v));
    localStorage.setItem("cart", JSON.stringify(v));
  }

  // ============================================
  // ✅ Imagen de productos
  // ============================================
  function srcDeProducto(p) {
    if (p && p.imagen) {
      const clean = String(p.imagen).replace(/^\/+/, "");
      return `${BACKEND_ORIGIN}/assets/img/productos/${clean}`;
    }
    return 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"><rect width="100%" height="100%" fill="%23e0e0e0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23666" font-family="Arial" font-size="20">Sin imagen</text></svg>';
  }

  // ============================================
  // ✅ Cargar productos
  // ============================================
  async function cargarProductos() {
    const cont = document.getElementById("productos");

    try {
      const res = await fetch(`${API_URL}/productos`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      productosCache = await res.json();
      cont.innerHTML = "";

      if (!Array.isArray(productosCache) || !productosCache.length) {
        cont.innerHTML = "<p>No hay productos disponibles.</p>";
        return;
      }

      productosCache.forEach(p => {
        const agotado = Number(p.cantidad || 0) <= 0;
        const imgSrc = srcDeProducto(p);

        cont.innerHTML += `
        <div class="producto-card">
          <img src="${imgSrc}" class="producto-img">
          <h3>${p.nombre}</h3>
          <p><b>Precio:</b> $${Number(p.precio).toLocaleString()}</p>
          <p><b>Stock:</b> ${p.cantidad}</p>
          <button class="btn-comprar" ${agotado ? "disabled" : ""}
            onclick="agregarAlCarritoPorId(${p.id})">
            ${agotado ? "Agotado" : "Añadir al carrito"}
          </button>
        </div>`;
      });

    } catch (err) {
      cont.innerHTML = `<p>Error cargando productos: ${String(err)}</p>`;
    }
  }

  // ============================================
  // ✅ Carrito
  // ============================================
  function toggleCarrito() {
    const panel = document.getElementById("carrito");
    panel.classList.toggle("abierto");
    const abierto = panel.classList.contains("abierto");
    panel.setAttribute("aria-hidden", abierto ? "false" : "true");
  }

  // ============================================
  // ✅ Modal de factura (compartido con cart)
  // ============================================
  function mostrarFacturaModal(venta, items) {
    const rows = (items || []).map(i => `
      <tr>
        <td>${i.nombre}</td>
        <td style="text-align:center">${Number(i.cantidad)}</td>
        <td style="text-align:right">$${Number(i.precio || i.precio_unitario).toLocaleString()}</td>
        <td style="text-align:right">$${(Number(i.precio || i.precio_unitario) * Number(i.cantidad)).toLocaleString()}</td>
      </tr>`).join('');

    const html = `
      <div style="text-align:left">
        <p><b>N° venta:</b> ${venta?.id ?? '-'}</p>
        <table style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead><tr><th>Producto</th><th>Cant.</th><th style=\"text-align:right\">Precio</th><th style=\"text-align:right\">Subtotal</th></tr></thead>
          <tbody>${rows}</tbody>
          <tfoot><tr><td colspan="3" style="text-align:right"><b>Total</b></td><td style="text-align:right"><b>$${Number(venta?.total || 0).toLocaleString()}</b></td></tr></tfoot>
        </table>
      </div>`;

    Swal.fire({ title: 'Pedido confirmado', html, width:700, showCloseButton:true, showCancelButton:true, confirmButtonText:'Descargar factura', cancelButtonText:'Cerrar' })
      .then(res => {
        if (res.isConfirmed) {
          if (window.jspdf && window.jspdf.jsPDF) {
            const { jsPDF } = window.jspdf;
            try {
              const doc = new jsPDF({ unit: 'pt', format: 'a4' });
              let y = 40;
              doc.setFontSize(16);
              doc.text(`Factura N° ${venta?.id ?? '-'}`, 40, y);
              y += 24;
              doc.setFontSize(12);
              doc.text(`Total: $${Number(venta?.total || 0).toLocaleString()}`, 40, y);
              y += 20;
              (items || []).forEach(it => {
                const precio = Number(it.precio || it.precio_unitario || 0);
                const cant = Number(it.cantidad || 0);
                const line = `${it.nombre} x${cant}  $${precio.toLocaleString()}  Sub: $${(precio*cant).toLocaleString()}`;
                const split = doc.splitTextToSize(line, 500);
                doc.text(split, 40, y);
                y += 14 * (split.length);
                if (y > 750) { doc.addPage(); y = 40; }
              });
              doc.save(`factura_${venta?.id ?? 'venta'}.pdf`);
            } catch (e) {
              const w = window.open('', '_blank'); w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Factura</title></head><body>${html}</body></html>`); w.document.close();
            }
          } else {
            const w = window.open('', '_blank'); w.document.write(`<!doctype html><html><head><meta charset=\"utf-8\"><title>Factura</title></head><body>${html}</body></html>`); w.document.close();
          }
        }
      });
  }

  function actualizarCarrito() {
    const cont = document.getElementById("carrito-items");
    const totalEl = document.getElementById("carrito-total");

    // Si el panel no existe (por alguna razón), solo sincroniza LS y sal.
    if (!cont || !totalEl) {
      setCartLS(carrito);
      return;
    }

    cont.innerHTML = "";
    let total = 0;

    carrito.forEach((it, i) => {
      total += it.precio * it.cantidad;

      cont.innerHTML += `
      <div class="carrito-item">
        <span>${it.nombre} - $${it.precio.toLocaleString()} x ${it.cantidad}</span>
        <button onclick="removerDelCarrito(${i})">Eliminar</button>
      </div>`;
    });

    totalEl.textContent = "Total: $" + total.toLocaleString();
    setCartLS(carrito);
  }

  window.removerDelCarrito = function(i) {
    carrito.splice(i, 1);
    actualizarCarrito();
  };

  window.agregarAlCarritoPorId = function(id) {
    const p = productosCache.find(x => x.id === id);
    if (!p) return;

    const enCarrito = carrito.find(x => x.id === id)?.cantidad || 0;
    const disponible = Number(p.cantidad);

    if (enCarrito + 1 > disponible) {
      Swal.fire({
        icon: "warning",
        title: "Stock insuficiente",
        text: `No hay suficiente stock de "${p.nombre}".`
      });
      return;
    }

    const ex = carrito.find(x => x.id === id);
    if (ex) {
      ex.cantidad++;
    } else {
      carrito.push({
        id: p.id,
        nombre: p.nombre,
        precio: Number(p.precio),
        cantidad: 1,
        imagen: srcDeProducto(p)
      });
    }

    actualizarCarrito();
    toggleCarrito();
  };

  window.irAlCarrito = function() {
    setCartLS(carrito);
    location.href = "../cart/cart.html";
  };

  // ============================================
  // ✅ FINALIZAR PEDIDO — (BLOQUE CORREGIDO)
  // ============================================
  document.addEventListener("DOMContentLoaded", () => {
    const btnFinal = document.querySelector(".btn-finalizar");
    if (btnFinal) btnFinal.addEventListener("click", finalizarDesdeCatalogo);
  });

  async function finalizarDesdeCatalogo() {
    if (!carrito.length) {
      Swal.fire({
        icon: "info",
        title: "Carrito vacío",
        text: "Tu carrito está vacío."
      });
      return;
    }

    const user = JSON.parse(localStorage.getItem("usuario") || "null");

    const payload = {
      clienteId: user?.id ?? null,
      metodoPago: "Efectivo",
      items: carrito.map(x => ({
        id: x.id,
        cantidad: x.cantidad
      }))
    }; // ✅ CERRADO CORRECTAMENTE

    try {
      const r = await fetch(`${API_URL}/checkout`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await r.json();

      if (!r.ok || !data.ok) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.mensaje || "No se pudo confirmar el pedido"
        });
        return;
      }

      mostrarFacturaModal(data.venta, data.venta.items || carrito);

      carrito = [];
      actualizarCarrito();
      localStorage.setItem("lastCheckout", Date.now());
      await cargarProductos();

    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Error procesando el pedido."
      });
    }
  }

  carrito = getCartLS();
  actualizarCarrito();
  cargarProductos();
  </script>
</body>
</html>
