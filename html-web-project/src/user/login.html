<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Iniciar Sesión - Ferretería Express</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0 }
    header { background:#373736; padding:15px; color:#fff; text-align:center }
    nav ul { list-style:none; margin:0; padding:0; display:flex; gap:14px; justify-content:center; flex-wrap:wrap }
    nav a { color:#fff; text-decoration:none; font-weight:bold }
    main { max-width:400px; margin:50px auto; background:#fff; padding:30px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1) }
    label { display:block; margin-top:10px; font-weight:bold }
    input { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:5px }
    button { width:100%; margin-top:20px; padding:10px; background:#ff6600; border:none; color:#fff; font-size:16px; font-weight:bold; border-radius:5px; cursor:pointer }
    button:hover { background:#e65100 }
    #msg { color:#c62828; text-align:center; margin-top:10px }
  </style>
</head>
<body>
<header>
  <h1>Ferretería Express</h1>
  <nav>
    <ul>
      <li><a href="../index.html">Inicio</a></li>
      <li><a href="../catalog/catalog.html">Catálogo</a></li>
      <li><a href="../cart/cart.html">Carrito</a></li>
      <!-- Estos IDs los usa auth.js para mostrar/ocultar según sesión -->
      <li><a id="link-login" href="./login.html">Login</a></li>
      <li><a id="link-reg" href="./register.html">Registro</a></li>
  <li><a id="link-profile" href="./profile.html" style="display:none">Mi perfil</a></li>
      <li><a id="link-logout" href="#" style="display:none">Cerrar sesión</a></li>
      <li><span id="saludo"></span></li>
    </ul>
  </nav>
</header>

<main>
  <h2>Iniciar Sesión</h2>
  <form id="loginForm" autocomplete="on">
  <label for="identificador">Correo o Usuario</label>
  <input type="text" id="identificador" required autocomplete="username" />
    <label for="password">Contraseña</label>
    <input type="password" id="password" required autocomplete="current-password" />
    <button type="submit">Iniciar sesión</button>
  </form>
  <p id="msg"></p>
</main>

<!-- Script de saludo/Logout que reutilizas en todas las páginas -->

<script src="../assets/js/auth.js"></script>
<!-- SweetAlert2 para mensajes bonitos de éxito/error -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>



<script>
  // URL fija de API en producción
  const API_URL = 'https://ferreteriaexpress.shop/api';
  // Endpoint principal bajo /api y fallback a raíz, por si el proxy solo expone uno de ellos
  const LOGIN_URL = API_URL.replace(/\/$/, '') + '/login';            // https://ferreteriaexpress.shop/api/login
  const LOGIN_URL_FALLBACK = new URL(API_URL).origin + '/login';       // https://ferreteriaexpress.shop/login

  const form = document.getElementById("loginForm");
  const msg = document.getElementById("msg");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.textContent = "";

    const identifier = document.getElementById("identificador").value.trim();
    const password = document.getElementById("password").value;

    if (!identifier || !password) {
      Swal.fire({ icon: 'warning', title: 'Datos incompletos', text: 'Ingresa tu correo/usuario y contraseña.' });
      return;
    }

    try {
      let res = await fetch(LOGIN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ identifier, password }),
      });

      // Si el primero no existe, reintenta contra la ruta raíz
      if (res.status === 404) {
        res = await fetch(LOGIN_URL_FALLBACK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identifier, password }),
        });
      }

      // Parseo seguro: si el servidor devuelve HTML (404), evita el error de JSON
      const contentType = res.headers.get('content-type') || '';
      let data;
      if (contentType.includes('application/json')) {
        data = await res.json();
      } else {
        const text = await res.text();
        data = { mensaje: text };
      }

      if (!res.ok) {
        msg.textContent = data.mensaje || "Error al iniciar sesión";
        Swal.fire({ icon: 'error', title: 'No pudiste iniciar sesión', text: data.mensaje || 'Verifica tus datos.' });
        return;
      }


  // Guarda al usuario y redirige al inicio
      localStorage.setItem("usuario", JSON.stringify(data.usuario));
      const nombre = data.usuario?.nombre || '';
      const correo = data.usuario?.correo || '';
      Swal.fire({
        icon: 'success',
        title: 'Sesión iniciada',
        html: `<p>Bienvenido${nombre ? `, <b>${nombre}</b>` : ''}.</p>${correo ? `<p><small>${correo}</small></p>` : ''}`,
        confirmButtonText: 'Continuar',
        confirmButtonColor: '#ff6600'
      }).then(() => {
        // Si navegas por archivos / Live Server:
        window.location.href = "../index.html";
        // Si sirves todo con Express y /src expuesto:
        // window.location.href = "/src/index.html";
      });
    } catch (error) {
      console.error(error);
      msg.textContent = "No se pudo conectar con el servidor.";
      Swal.fire({ icon: 'error', title: 'Fallo de conexión', text: 'Inténtalo nuevamente más tarde.' });
    }
  });
</script>
</body>
</html>




